<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>DZSphere</title>
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="#000000">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <script type="module">

        import * as THREE from "three";
        import {
            SphericalOptimizerState, normalizePoints,
            quadraticLineSearch, randomNormalArray, sphericalStep,
        } from "./SphericalOptimizer.js";
        import {
            calculateCoulombEnergy, calculateCoulombForces, constrainForces,
        } from "./CoulombEnergy.js";
        import {
            SphericalVoronoiVisualizer
        } from "./SphericalVoronoiVisualizer.js";

        const numPoints = 132;
        const initialPoints = randomNormalArray(3 * numPoints);
        normalizePoints(initialPoints);
        const initialEnergy = calculateCoulombEnergy(initialPoints);
        const initialForces = new Float64Array(3 * numPoints);
        calculateCoulombForces(initialForces, initialPoints);
        constrainForces(initialForces, initialPoints);
        const state = new SphericalOptimizerState(
            initialPoints, initialEnergy, initialForces, initialForces.slice());

        const visualizer = new SphericalVoronoiVisualizer(initialPoints);
        document.body.append(visualizer.domElement);

        const clock = new THREE.Clock();
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clock.stop();
            } else {
                clock.start();
            }
        });

        function animate() {
            requestAnimationFrame(animate);

            const stepSize = quadraticLineSearch(
                calculateCoulombEnergy, state, 1.0);
            sphericalStep(state.points,
                state.points, state.stepDirection, stepSize);
            state.energy = calculateCoulombEnergy(state.points);
            console.log(state.energy);
            calculateCoulombForces(state.forces, state.points);
            constrainForces(state.forces, state.points);
            state.stepDirection.set(state.forces);
            visualizer.updatePoints(state.points);
            visualizer.updateHull();

            visualizer.controls.update(clock.getDelta());
            visualizer.renderer.render(visualizer.scene, visualizer.camera);
        }

        animate();

    </script>
</body>

</html>
